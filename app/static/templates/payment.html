{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="bg-white shadow-xl rounded-lg overflow-hidden">
        <!-- Payment Header -->
        <div class="bg-blue-600 px-6 py-4">
            <h2 class="text-2xl font-bold text-white">Make Payment</h2>
        </div>

        {% if appointment %}
            <!-- Appointment Details -->
            <div class="p-6 border-b">
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Appointment Details</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Doctor</span>
                            <span class="font-medium">{{ appointment.doctor.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Date</span>
                            <span class="font-medium">{{ appointment.date.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Amount</span>
                            <span class="font-medium text-blue-600">{{ appointment.fee }} ETB</span>
                        </div>
                    </div>
                </div>

                <!-- Payment Form -->
                <div id="chapa-inline-form" class="mt-6"></div>
            </div>

            <script src="https://js.chapa.co/v1/inline.js"></script>
            <script>
                const chapa = new ChapaCheckout({
                    publicKey: '{{ chapa_public_key }}',
                    amount: '{{ appointment.fee }}',
                    currency: 'ETB',
                    tx_ref: '{{ appointment.id }}',
                    availablePaymentMethods: ['telebirr', 'cbebirr', 'ebirr', 'mpesa', 'chapa'],
                    customizations: {
                        buttonText: 'Pay Now',
                        styles: `
                            .chapa-pay-button { 
                                background-color: #2563eb !important; 
                                color: white !important;
                                padding: 0.75rem 1.5rem !important;
                                border-radius: 0.375rem !important;
                                font-weight: 500 !important;
                                width: 100% !important;
                                margin-top: 1rem !important;
                            }
                            .chapa-pay-button:hover {
                                background-color: #1d4ed8 !important;
                            }
                        `
                    },
                    callbackUrl: '{{ url_for("main.payment_callback", appointment_id=appointment.id, _external=True) }}',
                    returnUrl: '{{ url_for("main.payment_success", appointment_id=appointment.id, _external=True) }}',
                    onSuccessfulPayment: function(response) {
                        window.location.href = '{{ url_for("main.payment_success", appointment_id=appointment.id) }}';
                    },
                    onPaymentFailure: function(error) {
                        alert('Payment failed: ' + error.message);
                    },
                    onClose: function() {
                        window.location.href = '{{ url_for("main.manage_appointments") }}';
                    }
                });

                chapa.initialize('chapa-inline-form');
            </script>
        {% else %}
            <div class="p-6 text-center">
                <div class="text-red-600 mb-4">
                    <i class="fas fa-exclamation-circle text-4xl"></i>
                </div>
                <p class="text-gray-700 mb-4">No appointment found or invalid appointment.</p>
                <a href="{{ url_for('main.manage_appointments') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    Return to Appointments
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}